
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hardening and Security Guidance &#8212; ownCloud 10.0.7 Server Administration Manual 10.0.7 documentation</title>
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/responsive.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Password Policy" href="security/password-policy.html" />
    <link rel="prev" title="Logging Configuration" href="logging_configuration.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">
(function () {
  /**
   * Patch TOC list.
   *
   * Will mutate the underlying span to have a correct ul for nav.
   *
   * @param $span: Span containing nested UL's to mutate.
   * @param minLevel: Starting level for nested lists. (1: global, 2: local).
   */
  var patchToc = function ($ul, minLevel) {
    var findA;

    // Find all a "internal" tags, traversing recursively.
    findA = function ($elem, level) {
      var level = level || 0,
        $items = $elem.find("> li > a.internal, > ul, > li > ul");

      // Iterate everything in order.
      $items.each(function (index, item) {
        var $item = $(item),
          tag = item.tagName.toLowerCase(),
          pad = 15 + ((level - minLevel) * 10);

        if (tag === 'a' && level >= minLevel) {
          // Add to existing padding.
          $item.css('padding-left', pad + "px");
          console.log(level, $item, 'padding-left', pad + "px");
        } else if (tag === 'ul') {
          // Recurse.
          findA($item, level + 1);
        }
      });
    };

    console.log("HERE");
    findA($ul);
  };

  $(document).ready(function () {
    // Add styling, structure to TOC's.
    $(".dropdown-menu").each(function () {
      $(this).find("ul").each(function (index, item){
        var $item = $(item);
        $item.addClass('unstyled');
      });
      $(this).find("li").each(function () {
        $(this).parent().append(this);
      });
    });

    // Patch in level.
    patchToc($("ul.globaltoc"), 2);
    patchToc($("ul.localtoc"), 2);

    // Enable dropdown.
    $('.dropdown-toggle').dropdown();
  });
}());
</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://piwik.owncloud.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '4']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Piwik Code -->

  </head><body>
  

<noscript><p><img src="https://piwik.owncloud.com/piwik.php?idsite=4&rec=1" style="border:0" alt=""></p></noscript>
<div class="header_con">
<div class="container">
<h1 id="site-title"><a href="http://doc.owncloud.com" title="ownCloud" rel="home">ownCloud</a></h1>

<form class="headersearch" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>

<div class="follow">
<p><a class="visible" href="https://owncloud.com" title="ownCloud">Back to owncloud.com</a>|<span class="visible">Follow us:</span></p>
<a class="twitter" href="https://twitter.com/owncloud" target="_blank">Twitter</a>
<a class="facebook" href="http://www.facebook.com/owncloud" target="_blank">Facebook</a>
<a class="google" href="https://plus.google.com/+OwncloudOfficial" target="_blank">Google</a>
</div>

</div>
</div>

<div id="main">
<div class="container">
  <div class="content">

    </div>
    
			<div class="row">
				<div class="span3">
					<div class="sidebar">
						<div class="box sidenavi">
							<div class="menu-support-container">
								<ul id="menu-support" class="menu">
									<ul>

<li><a href="../../contents.html">Table of Contents</a></li>
									</ul>
                  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats_new_admin.html">What’s New in ownCloud 10.0.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../database/index.html">Database Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.html">File Sharing and Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap/ldap_proxy_cache_server_setup.html">How To Install and Configure an LDAP Proxy-Cache Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mimetypes/index.html">Mimetypes Management</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Server Configuration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="security_setup_warnings.html">Warnings on Admin Page</a></li>
<li class="toctree-l3"><a class="reference internal" href="import_ssl_cert.html">Importing System-wide and Personal SSL Certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="occ_command.html">Using the occ Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="activity_configuration.html">Configuring the Activity App</a></li>
<li class="toctree-l3"><a class="reference internal" href="antivirus_configuration.html">Virus Scanner Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="caching_configuration.html">Memory Caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="background_jobs_configuration.html">Background Jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="config_sample_php_parameters.html">Config.php Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="email_configuration.html">Email Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="excluded_blacklisted_files.html">Excluding Directories and Blacklisting Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="external_sites.html">Linking External Sites</a></li>
<li class="toctree-l3"><a class="reference internal" href="custom_client_repos.html">Custom Client Download Repositories</a></li>
<li class="toctree-l3"><a class="reference internal" href="knowledgebase_configuration.html">Knowledge Base Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="language_configuration.html">Language Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging_configuration.html">Logging Configuration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Hardening and Security Guidance</a></li>
<li class="toctree-l3"><a class="reference internal" href="security/password-policy.html">Password Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="reverse_proxy_configuration.html">Reverse Proxy Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="thirdparty_php_configuration.html">Using Third Party PHP Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="automatic_configuration.html">Automatic Configuration Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="oc_server_tuning.html">ownCloud Server Tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="index_php_less_urls.html">Enable index.php-less URLs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/index.html">User Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../maintenance/index.html">Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../issues/index.html">Issues and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../enterprise/index.html">Enterprise Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appliance/index.html">The ownCloud X Appliance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
</ul>

								</ul>
							</div>
						</div>
					</div>
				</div>
        

				<div class="span9">
					<div class="page-content">
						
  <div class="section" id="hardening-and-security-guidance">
<h1>Hardening and Security Guidance<a class="headerlink" href="#hardening-and-security-guidance" title="Permalink to this headline">¶</a></h1>
<p>ownCloud aims to ship with secure defaults that do not need to get modified by
administrators. However, in some cases some additional security hardening can be
applied in scenarios were the administrator has complete control over
the ownCloud instance. This page assumes that you run ownCloud Server on Apache2
in a Linux environment.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ownCloud will warn you in the administration interface if some
critical security-relevant options are missing. However, it is still up to
the server administrator to review and maintain system security.</p>
</div>
<div class="section" id="limit-on-password-length">
<h2>Limit on Password Length<a class="headerlink" href="#limit-on-password-length" title="Permalink to this headline">¶</a></h2>
<p>ownCloud uses the <a class="reference external" href="https://en.m.wikipedia.org/wiki/Bcrypt">bcrypt</a> algorithm, and thus for security and performance reasons, e.g., denial of service as CPU demand increases exponentially, it only verifies the first 72 characters of passwords.
This applies to all passwords that you use in ownCloud: user passwords, passwords on link shares, and passwords on external shares.</p>
</div>
<div class="section" id="operating-system">
<h2>Operating system<a class="headerlink" href="#operating-system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="give-php-read-access-to-dev-urandom">
<span id="dev-urandom-label"></span><h3>Give PHP read access to <code class="docutils literal notranslate"><span class="pre">/dev/urandom</span></code><a class="headerlink" href="#give-php-read-access-to-dev-urandom" title="Permalink to this headline">¶</a></h3>
<p>ownCloud uses a <a class="reference external" href="https://tools.ietf.org/html/rfc4086#section-5.2">RFC 4086 (“Randomness Requirements for Security”)</a> compliant
mixer to generate cryptographically secure pseudo-random numbers. This means
that when generating a random number ownCloud will request multiple random
numbers from different sources and derive from these the final random number.</p>
<p>The random number generation also tries to request random numbers from
<code class="docutils literal notranslate"><span class="pre">/dev/urandom</span></code>, thus it is highly recommended to configure your setup in such
a way that PHP is able to read random data from it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When having an <code class="docutils literal notranslate"><span class="pre">open_basedir</span></code> configured within your <code class="docutils literal notranslate"><span class="pre">php.ini</span></code> file,
make sure to include <code class="docutils literal notranslate"><span class="pre">/dev/urandom</span></code>.</p>
</div>
</div>
<div class="section" id="enable-hardening-modules-such-as-selinux">
<h3>Enable hardening modules such as SELinux<a class="headerlink" href="#enable-hardening-modules-such-as-selinux" title="Permalink to this headline">¶</a></h3>
<p>It is highly recommended to enable hardening modules such as SELinux where
possible. See <a class="reference internal" href="../../installation/selinux_configuration.html"><span class="doc">SELinux Configuration</span></a> to learn more about
SELinux.</p>
</div>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="place-data-directory-outside-of-the-web-root">
<h3>Place data directory outside of the web root<a class="headerlink" href="#place-data-directory-outside-of-the-web-root" title="Permalink to this headline">¶</a></h3>
<p>It is highly recommended to place your data directory outside of the Web root
(i.e. outside of <code class="docutils literal notranslate"><span class="pre">/var/www</span></code>). It is easiest to do this on a new
installation.</p>
</div>
<div class="section" id="disable-preview-image-generation">
<h3>Disable preview image generation<a class="headerlink" href="#disable-preview-image-generation" title="Permalink to this headline">¶</a></h3>
<p>ownCloud is able to generate preview images of common filetypes such as images
or text files. By default the preview generation for some file types that we
consider secure enough for deployment is enabled by default. However,
administrators should be aware that these previews are generated using PHP
libraries written in C which might be vulnerable to attack vectors.</p>
<p>For high security deployments we recommend disabling the preview generation by
setting the <code class="docutils literal notranslate"><span class="pre">enable_previews</span></code> switch to <code class="docutils literal notranslate"><span class="pre">false</span></code> in <code class="docutils literal notranslate"><span class="pre">config.php</span></code>. As an
administrator you are also able to manage which preview providers are enabled by
modifying the <code class="docutils literal notranslate"><span class="pre">enabledPreviewProviders</span></code> option switch.</p>
</div>
</div>
<div class="section" id="use-https">
<span id="use-https-label"></span><h2>Use HTTPS<a class="headerlink" href="#use-https" title="Permalink to this headline">¶</a></h2>
<p>Using ownCloud without using an encrypted HTTPS connection opens up your server
to a man-in-the-middle (MITM) attack, and risks the interception of user data
and passwords. It is a best practice, and highly recommended, to always use
HTTPS on production servers, and to never allow unencrypted HTTP.</p>
<p>How to setup HTTPS on your Web server depends on your setup; please consult the
documentation for your HTTP server. The following examples are for Apache.</p>
<div class="section" id="redirect-all-unencrypted-traffic-to-https">
<h3>Redirect all unencrypted traffic to HTTPS<a class="headerlink" href="#redirect-all-unencrypted-traffic-to-https" title="Permalink to this headline">¶</a></h3>
<p>To redirect all HTTP traffic to HTTPS administrators are encouraged to issue a
permanent redirect using the 301 status code. When using Apache this can be
achieved by adding a setting such as the following in the Apache VirtualHosts
configuration containing the <code class="docutils literal notranslate"><span class="pre">&lt;VirtualHost</span> <span class="pre">*:80&gt;</span></code> entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Redirect</span> <span class="n">permanent</span> <span class="o">/</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="enable-http-strict-transport-security">
<span id="enable-hsts-label"></span><h3>Enable HTTP Strict Transport Security<a class="headerlink" href="#enable-http-strict-transport-security" title="Permalink to this headline">¶</a></h3>
<p>While redirecting all traffic to HTTPS is good, it may not completely prevent
man-in-the-middle attacks. Thus administrators are encouraged to set the HTTP
Strict Transport Security header, which instructs browsers to not allow any
connection to the ownCloud instance using HTTP, and it attempts to prevent site
visitors from bypassing invalid certificate warnings.</p>
<p>This can be achieved by setting the following settings within the Apache
VirtualHost file containing the <code class="docutils literal notranslate"><span class="pre">&lt;VirtualHost</span> <span class="pre">*:443&gt;</span></code> entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">IfModule</span> <span class="n">mod_headers</span><span class="o">.</span><span class="n">c</span><span class="o">&gt;</span>
  <span class="n">Header</span> <span class="n">always</span> <span class="nb">set</span> <span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span> <span class="s2">&quot;max-age=15552000; includeSubDomains&quot;</span>
<span class="o">&lt;/</span><span class="n">IfModule</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>If you don’t have access to your Apache configuration it is also possible to add this
to the main <code class="docutils literal notranslate"><span class="pre">.htaccess</span></code> file shipped with ownCloud. Make sure you’re adding it below
the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#### DO NOT CHANGE ANYTHING ABOVE THIS LINE ####</span>
</pre></div>
</div>
<p>This example configuration will make all subdomains only accessible via HTTPS.
If you have subdomains not accessible via HTTPS, remove <code class="docutils literal notranslate"><span class="pre">includeSubDomains</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This requires the <code class="docutils literal notranslate"><span class="pre">mod_headers</span></code> extension in Apache.</p>
</div>
</div>
<div class="section" id="proper-ssl-configuration">
<h3>Proper SSL configuration<a class="headerlink" href="#proper-ssl-configuration" title="Permalink to this headline">¶</a></h3>
<p>Default SSL configurations by Web servers are often not state-of-the-art, and
require fine-tuning for an optimal performance and security experience. The
available SSL ciphers and options depend completely on your environment and
thus giving a generic recommendation is not really possible.</p>
<p>We recommend using the <a class="reference external" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">Mozilla SSL Configuration Generator</a> to generate a
suitable configuration suited for your environment, and the free <a class="reference external" href="https://www.ssllabs.com/ssltest/">Qualys
SSL Labs Tests</a> gives good guidance on whether your SSL server is correctly
configured.</p>
<p>Also ensure that HTTP compression is disabled to mitigate the BREACH attack.</p>
</div>
</div>
<div class="section" id="use-a-dedicated-domain-for-owncloud">
<h2>Use a dedicated domain for ownCloud<a class="headerlink" href="#use-a-dedicated-domain-for-owncloud" title="Permalink to this headline">¶</a></h2>
<p>Administrators are encouraged to install ownCloud on a dedicated domain such as
cloud.domain.tld instead of domain.tld to gain all the benefits offered by the
Same-Origin-Policy.</p>
</div>
<div class="section" id="ensure-that-your-owncloud-instance-is-installed-in-a-dmz">
<h2>Ensure that your ownCloud instance is installed in a DMZ<a class="headerlink" href="#ensure-that-your-owncloud-instance-is-installed-in-a-dmz" title="Permalink to this headline">¶</a></h2>
<p>As ownCloud supports features such as Federated File Sharing we do not consider
Server Side Request Forgery (SSRF) part of our threat model. In fact, given all our
external storage adapters this can be considered a feature and not a vulnerability.</p>
<p>This means that a user on your ownCloud instance could probe whether other hosts
are accessible from the ownCloud network. If you do not want this you need to
ensure that your ownCloud is properly installed in a segregated network and proper
firewall rules are in place.</p>
</div>
<div class="section" id="serve-security-related-headers-by-the-web-server">
<h2>Serve security related Headers by the Web server<a class="headerlink" href="#serve-security-related-headers-by-the-web-server" title="Permalink to this headline">¶</a></h2>
<p>Basic security headers are served by ownCloud already in a default environment.
These include:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">X-Content-Type-Options:</span> <span class="pre">nosniff</span></code></dt>
<dd><ul class="first last">
<li>Instructs some browsers to not sniff the mimetype of files. This is used for example to prevent browsers from interpreting text files as JavaScript.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">X-XSS-Protection:</span> <span class="pre">1;</span> <span class="pre">mode=block</span></code></dt>
<dd><ul class="first last">
<li>Instructs browsers to enable their browser side Cross-Site-Scripting filter.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">X-Robots-Tag:</span> <span class="pre">none</span></code></dt>
<dd><ul class="first last">
<li>Instructs search machines to not index these pages.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">X-Frame-Options:</span> <span class="pre">SAMEORIGIN</span></code></dt>
<dd><ul class="first last">
<li>Prevents embedding of the ownCloud instance within an iframe from other domains to prevent Clickjacking and other similar attacks.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>These headers are hard-coded into the ownCloud server, and need no intervention
by the server administrator.</p>
<p>For optimal security, administrators are encouraged to serve these basic HTTP
headers by the Web server to enforce them on response. To do this Apache has to
be configured to use the <code class="docutils literal notranslate"><span class="pre">.htaccess</span></code> file and the following Apache
modules need to be enabled:</p>
<ul class="simple">
<li>mod_headers</li>
<li>mod_env</li>
</ul>
<p>Administrators can verify whether this security change is active by accessing a
static resource served by the Web server and verify that the above mentioned
security headers are shipped.</p>
</div>
<div class="section" id="use-fail2ban">
<h2>Use Fail2ban<a class="headerlink" href="#use-fail2ban" title="Permalink to this headline">¶</a></h2>
<p>Another approach to hardening the server(s) on which your ownCloud installation rest is using an intrusion detection system.
An excellent one is <a class="reference external" href="https://www.fail2ban.org/wiki/index.php/Main_Page">Fail2ban</a>.
Fail2ban is designed to protect servers from brute force attacks.
It works by monitoring log files (such as those for <em>ssh</em>, <em>web</em>, <em>mail</em>, and <em>log</em> servers) for certain patterns, specific to each server, and taking actions should those patterns be found.</p>
<p>Actions include banning the IP from which the detected actions are being made from.
This serves to both make the process more difficult as well as to prevent DDOS-style attacks.
However, after a predefined time period, the banned IP is normally un-banned again.</p>
<p>This helps if the login attempts were genuine, so the user doesn’t lock themselves out permanently.
An example of such an action is users attempting to brute force login to a server via ssh.
In this case, Fail2ban would look for something similar to the following in <code class="docutils literal notranslate"><span class="pre">/var/log/auth.log</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">37</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10912</span><span class="p">]:</span> <span class="n">input_userauth_request</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">user</span> <span class="n">audra</span> <span class="p">[</span><span class="n">preauth</span><span class="p">]</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">37</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10912</span><span class="p">]:</span> <span class="n">pam_unix</span><span class="p">(</span><span class="n">sshd</span><span class="p">:</span><span class="n">auth</span><span class="p">):</span> <span class="n">check</span> <span class="k">pass</span><span class="p">;</span> <span class="n">user</span> <span class="n">unknown</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">51</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10835</span><span class="p">]:</span> <span class="n">PAM</span> <span class="mi">2</span> <span class="n">more</span> <span class="n">authentication</span> <span class="n">failures</span><span class="p">;</span> <span class="n">logname</span><span class="o">=</span> <span class="n">uid</span><span class="o">=</span><span class="mi">0</span> <span class="n">euid</span><span class="o">=</span><span class="mi">0</span> <span class="n">tty</span><span class="o">=</span><span class="n">ssh</span> <span class="n">ruser</span><span class="o">=</span> <span class="n">rhost</span><span class="o">=</span><span class="mf">221.194</span><span class="o">.</span><span class="mf">44.231</span>  <span class="n">user</span><span class="o">=</span><span class="n">root</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">57</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10837</span><span class="p">]:</span> <span class="n">pam_unix</span><span class="p">(</span><span class="n">sshd</span><span class="p">:</span><span class="n">auth</span><span class="p">):</span> <span class="n">authentication</span> <span class="n">failure</span><span class="p">;</span> <span class="n">logname</span><span class="o">=</span> <span class="n">uid</span><span class="o">=</span><span class="mi">0</span> <span class="n">euid</span><span class="o">=</span><span class="mi">0</span> <span class="n">tty</span><span class="o">=</span><span class="n">ssh</span> <span class="n">ruser</span><span class="o">=</span> <span class="n">rhost</span><span class="o">=</span><span class="mf">221.194</span><span class="o">.</span><span class="mf">44.231</span>  <span class="n">user</span><span class="o">=</span><span class="n">root</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">59</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10837</span><span class="p">]:</span> <span class="n">Failed</span> <span class="n">password</span> <span class="k">for</span> <span class="n">root</span> <span class="kn">from</span> <span class="mf">221.194</span><span class="o">.</span><span class="mf">44.231</span> <span class="n">port</span> <span class="mi">46838</span> <span class="n">ssh2</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">04</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10837</span><span class="p">]:</span> <span class="n">message</span> <span class="n">repeated</span> <span class="mi">2</span> <span class="n">times</span><span class="p">:</span> <span class="p">[</span> <span class="n">Failed</span> <span class="n">password</span> <span class="k">for</span> <span class="n">root</span> <span class="kn">from</span> <span class="mf">221.194</span><span class="o">.</span><span class="mf">44.231</span> <span class="n">port</span> <span class="mi">46838</span> <span class="n">ssh2</span><span class="p">]</span>
<span class="n">Mar</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">04</span> <span class="n">yourhost</span> <span class="n">sshd</span><span class="p">[</span><span class="mi">10837</span><span class="p">]:</span> <span class="n">Received</span> <span class="n">disconnect</span> <span class="kn">from</span> <span class="mf">221.194</span><span class="o">.</span><span class="mf">44.231</span><span class="p">:</span> <span class="mi">11</span><span class="p">:</span>  <span class="p">[</span><span class="n">preauth</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you’re not familiar with what’s going on, this snippet highlights a number of failed login attempts being made.</p>
</div>
<div class="section" id="using-fail2ban-to-secure-an-owncloud-login">
<h3>Using Fail2ban to secure an ownCloud login<a class="headerlink" href="#using-fail2ban-to-secure-an-owncloud-login" title="Permalink to this headline">¶</a></h3>
<p>On Ubuntu, you can install Fail2ban using the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span> <span class="n">upgrade</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">fail2ban</span>
</pre></div>
</div>
<p>Fail2ban installs several default filters for <em>Apache</em>, <em>NGINX</em>, and various other services, but none for ownCloud.
Given that, we have to define our own filter.
To do so, you first need to make sure that ownCloud uses your local timezone for writing log entries; otherwise, fail2ban cannot react appropriately to attacks.
To do this, edit your <code class="docutils literal notranslate"><span class="pre">config.php</span></code> file and add the following line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;logtimezone&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Europe/Berlin&#39;</span><span class="p">,</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Adjust the timezone to the one that your server is located in, based on <a class="reference external" href="https://secure.php.net/manual/en/timezones.php">PHP’s list of supported timezones</a>.</p>
</div>
<p>This change takes effect as soon as you save <code class="docutils literal notranslate"><span class="pre">config.php</span></code>.
You can test the change by:</p>
<ol class="arabic simple">
<li>Entering false credentials at your ownCloud login screen</li>
<li>Checking the timestamp of the resulting entry in ownCloud’s log file.</li>
</ol>
<p>Next, define a new Fail2ban filter rule for ownCloud.
To do so, create a new file called <code class="docutils literal notranslate"><span class="pre">/etc/fail2ban/filter.d/owncloud.conf</span></code>, and insert the following configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Definition</span><span class="p">]</span>
<span class="n">failregex</span><span class="o">=</span><span class="p">{</span><span class="o">.*</span><span class="n">Login</span> <span class="n">failed</span><span class="p">:</span> \<span class="s1">&#39;.*</span><span class="se">\&#39;</span><span class="s1"> \(Remote IP: </span><span class="se">\&#39;</span><span class="s1">&lt;HOST&gt;</span><span class="se">\&#39;</span><span class="s1">\)&quot;}</span>
<span class="n">ignoreregex</span> <span class="o">=</span>
</pre></div>
</div>
<p>This filter needs to be loaded when Fail2ban starts, so a further configuration entry is required to be added in <code class="docutils literal notranslate"><span class="pre">/etc/fail2ban/jail.d/defaults-debian.conf</span></code>, which you can see below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">owncloud</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span><span class="mi">443</span>
<span class="n">protocol</span> <span class="o">=</span> <span class="n">tcp</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">owncloud</span>
<span class="n">maxretry</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">bantime</span> <span class="o">=</span> <span class="mi">10800</span>
<span class="n">logpath</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">owncloud_data</span><span class="o">/</span><span class="n">owncloud</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>This configuration:</p>
<ol class="arabic simple">
<li>Enables the filter rules for TCP requests on ports 80 and 443.</li>
<li>Bans IPs for 10800 seconds (3 hours).</li>
<li>Sets the path to the log file to analyze for malicious logins</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The most important part of the configuration is the <code class="docutils literal notranslate"><span class="pre">logpath</span></code> parameter.
If this does not point to the correct log file, Fail2ban will either not work properly or refuse to start.</p>
</div>
<p>After saving the file, restart Fail2ban by running the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">fail2ban</span> <span class="n">restart</span>
</pre></div>
</div>
<p>To test that the new ownCloud configuration has been loaded, use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span> <span class="n">status</span>
</pre></div>
</div>
<p>If “owncloud” is listed in the console output, the filter is both loaded and active.
If you want to test the filter, run the following command, adjusting the path to your <code class="docutils literal notranslate"><span class="pre">owncloud.log</span></code>, if necessary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fail2ban</span><span class="o">-</span><span class="n">regex</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">owncloud_data</span><span class="o">/</span><span class="n">owncloud</span><span class="o">.</span><span class="n">log</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="nb">filter</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">owncloud</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>The output will look similar to the following, if you had one failed login attempt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>fail2ban-regex /var/www/owncloud_data/owncloud.log /etc/fail2ban/filter.d/owncloud.conf

Running tests
=============

Use   failregex file : /etc/fail2ban/filter.d/owncloud.conf
Use         log file : /var/www/owncloud_data/owncloud.log


Results
=======

Failregex: 1 total
|-  #) [# of hits] regular expression
|   1) [1] {.*Login failed: \&#39;.*\&#39; \(Remote IP: \&#39;&lt;HOST&gt;\&#39;\)&quot;}
`-

Ignoreregex: 0 total

Date template hits:
|- [# of hits] date format
|  [40252] ISO 8601
`-

Lines: 40252 lines, 0 ignored, 1 matched, 40251 missed
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Failregex</span></code> counter increments by 1 for every failed login attempt.
To un-ban an IP, which was locked either during testing or unintentionally, use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span> <span class="nb">set</span> <span class="n">owncloud</span> <span class="n">unbanip</span> <span class="o">&lt;</span><span class="n">IP</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>You can check the status of your ownCloud filter with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span> <span class="n">status</span> <span class="n">owncloud</span>
</pre></div>
</div>
<p>This will produce an output similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Status for the jail: owncloud
|- filter
|  |- File list:    /var/www/owncloud_data/owncloud.log
|  |- Currently failed: 1
|  `- Total failed: 7
`- action
   |- Currently banned: 0
   |  `- IP list:
   `- Total banned: 1
</pre></div>
</div>
</div>
</div>
</div>


					</div>
				</div>
			</div>

  </div>
</div>
</div>
<footer class="footer">
  <div class="container">
  <div class="footer_navi">

  <div class="menu-footer-navigation-container">
  	<ul id="menu-footer-navigation" class="menu">
  		<li><a href="https://owncloud.com">Home</a></li>
  		<li><a href="https://owncloud.com/about">About ownCloud</a></li>
  		<li><a href="https://owncloud.com/resources">Resources</a></li>
  		<li><a href="https://owncloud.com/become-partner">Become a Partner</a></li>
  		<li><a href="https://owncloud.org">Community</a></li>
  		<li><a href="https://owncloud.com/blog">Blog</a></li>
  		<li><a href="https://owncloud.com/jobs">Jobs</a></li>
  		<li><a href="https://owncloud.com/contact">Contact</a></li>
  	</ul>
  </div>

  <div class="follow_f">
  	<ul>
  		<li><a class="twitter" href="https://twitter.com/ownloud" target="_blank">Twitter</a></li>
  		<li><a class="facebook" href="http://www.facebook.com/owncloud" target="_blank">Facebook</a></li>
  		<li><a class="google" href="https://plus.google.com/+OwncloudOfficial" target="_blank">Google</a></li>
  	</ul>
  </div>

  <p class="copyright">© ownCloud 2011-2015</p>

  </div>
  </div>
</footer>
  </body>
</html>