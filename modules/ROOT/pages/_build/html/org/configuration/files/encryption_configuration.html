<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Encryption Configuration &#8212; ownCloud 10.0.8 Server Administration Manual 10.0.8 documentation</title>
    <link rel="stylesheet" href="../../_static/" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/main.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/styles.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Transactional File Locking" href="files_locking_transactional.html" />
    <link rel="prev" title="External Storage Authentication mechanisms" href="external_storage/auth_mechanisms.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1d2d44">
<link rel="shortcut icon" href="https://owncloud.org/wp-content/themes/owncloudorgnew/assets/img/common/favicon.png" />
<link rel="apple-touch-icon-precomposed" href="https://owncloud.org/wp-content/themes/owncloudorgnew/assets/img/common/favicon.png" />

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https//piwik.owncloud.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '4']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Piwik Code -->

  </head><body>
<noscript><p><img src="https://piwik.owncloud.com/piwik.php?idsite=4&rec=1" style="border:0" alt=""></p></noscript>

<header class="banner navbar navbar-default navbar-static-top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="brand" href="http://owncloud.org/" rel="home" title="ownCloud.org"><img class="logo" src="../../_static/img/logo_owncloud.svg" itemprop="logo"></a>
    </div>

    <nav class="collapse navbar-collapse" role="navigation">
      <ul id="menu-header" class="nav navbar-nav">
        <li class="menu-news"><a href="https://owncloud.org/news/">News</a></li>
        <li class="menu-features"><a href="https://owncloud.org/features/">Features</a></li>
        <li class="menu-demo"><a target="_blank" href="https://demo.owncloud.org">Demo</a></li>
        <li class="menu-documentation top-nav-active"><a href="https://doc.owncloud.org">Documentation</a></li>
        <li class="menu-contribute"><a href="https://owncloud.org/contribute/">Contribute</a>
        <li class="menu-support"><a href="https://owncloud.org/support">Support</a></li>
        <li class="menu-commercial"><a target="_blank" href="https://owncloud.com">Enterprise Edition</a></li>
        <li class="menu-install"><a href="https://owncloud.org/install/">Download</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="wrap container not-front">
  <div class="content row">
  <main class="main">
    <div class="row page-content-header">
      <div class="col-md-6">
        <h1><a href="../../contents.html">ownCloud 10.0.8 Server Administration Manual</a></h1>
      </div>
      <div class="col-md-5 col-md-offset-1">
      
        <form class="headersearch" style="margin-bottom:-3px;" action="../../search.html" method="get">
        <input type="text" value="" name="q" id="q" class="form-control" />
        <button  class="btn btn-default" type="submit" id="searchsubmit">Search</button>
        </form>
      
      </div>
    </div>
    
			<div class="row">
				<div class="col-md-3">
					<div class="sidebar">
							<div class="menu-support-container">
								<ul id="menu-support" class="menu">
									<ul>

<li><a href="../../contents.html">Table of Contents</a></li>
									</ul>
                  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats_new_admin.html">What’s New in ownCloud 10.0.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../database/index.html">Database Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">File Sharing and Management</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="file_sharing_configuration.html">File Sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="federated_cloud_sharing_configuration.html">Configuring Federation Sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="big_file_upload_configuration.html">Uploading big files &gt; 512MB</a></li>
<li class="toctree-l3"><a class="reference internal" href="default_files_configuration.html">Providing Default Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="external_storage_configuration_gui.html">Configuring External Storage (GUI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="external_storage_configuration.html">Configuring External Storage (Configuration File)</a></li>
<li class="toctree-l3"><a class="reference internal" href="external_storage/auth_mechanisms.html">External Storage Authentication mechanisms</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Encryption Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="files_locking_transactional.html">Transactional File Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="previews_configuration.html">Previews Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="file_versioning.html">Controlling File Versions and Aging</a></li>
<li class="toctree-l3"><a class="reference internal" href="trashbin_options.html">Managing the Trashbin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ldap/ldap_proxy_cache_server_setup.html">How To Install and Configure an LDAP Proxy-Cache Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mimetypes/index.html">Mimetypes Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../server/index.html">Server Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/index.html">User Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../maintenance/index.html">Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../issues/index.html">Issues and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../enterprise/index.html">Enterprise Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appliance/index.html">The ownCloud X Appliance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
</ul>

								</ul>
							</div>
					</div>
				</div>
        

				<div class="col-md-9">
					<div class="page-content">
            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="external_storage/auth_mechanisms.html" title="Previous Chapter: External Storage Authentication mechanisms"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; External Stor...</span>
    </a>
  </li>
  <li class="next">
    <a href="files_locking_transactional.html" title="Next Chapter: Transactional File Locking"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Transactional... &raquo;</span>
    </a>
  </li>
</ul>
						
  <div class="section" id="encryption-configuration">
<h1>Encryption Configuration<a class="headerlink" href="#encryption-configuration" title="Permalink to this headline">¶</a></h1>
<p>The primary purpose of the ownCloud server-side encryption is to protect users’ files when they’re located on remote storages, such as Dropbox and Google Drive, and to do it smoothly and seamlessly from within ownCloud.</p>
<p>From ownCloud 9.0, server-side encryption for local and remote storages can operate independently of each other.
By doing so, you can encrypt a remote storage <em>without</em> also having to encrypt your home storage on your ownCloud server.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Starting with ownCloud 9.0 we support Authenticated Encryption for all newly encrypted files. See <a class="reference external" href="https://hackerone.com/reports/108082">https://hackerone.com/reports/108082</a> for more technical information about the impact.</p>
</div>
<p>For maximum security make sure to configure external storage with “<em>Check for changes: Never</em>.”
This will let ownCloud ignore new files not added via ownCloud.
By doing so, a malicious external storage administrator cannot add new files to the storage without your knowledge.
However, this is not wise <em>if</em> your external storage is subject to legitimate external changes.</p>
<p>ownCloud’s server-side encryption encrypts files stored on the ownCloud server and files on remote storages that are connected to your ownCloud server.
Encryption and decryption are performed on the ownCloud server.
All files sent to remote storage will be encrypted by the ownCloud server and decrypted before serving them to you or anyone whom you have shared them with.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Encrypting files increases their size by roughly 35%. Remember to take this into account when you are both provisioning storage and setting storage quotas. Secondly, user quotas are based on the <em>unencrypted</em> file size — <strong>not</strong> the encrypted size.</p>
</div>
<p>When files on an external storage are encrypted in ownCloud, you cannot share them directly from the external storage services, only through ownCloud sharing.
This is because the key to decrypt the data <strong>never</strong> leaves the ownCloud server.</p>
<p>ownCloud’s server-side encryption generates a strong encryption key, which is unlocked by users’ passwords.
As a result, your users don’t need to track an extra password.
All they need to do is log in as they normally would.
ownCloud, transparently, encrypts only the contents of files, and not filenames and directory structures.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">You should regularly backup all encryption keys to prevent permanent data loss.</p>
</div>
<p>The encryption keys are stored in the following directories:</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Directory</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">data/&lt;user&gt;/files_encryption</span></code></td>
<td>Users’ private keys and all other keys
necessary to decrypt the users’ files.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">data/files_encryption</span></code></td>
<td>Private keys and all other keys necessary to
decrypt the files stored on a system wide
external storage.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can move the keys to a different location. To do so, refer to the <a class="reference internal" href="#move-key-location">Move Key Location</a> section of the documentation.</p>
</div>
<p>When encryption is enabled, all files are encrypted and decrypted by the
ownCloud application, and stored encrypted on your remote storage.
This protects your data on externally hosted storage.
The ownCloud admin and the storage admin will see only encrypted files when browsing backend storage.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Encryption keys are stored only on the ownCloud server,
eliminating exposure of your data to third-party storage providers. The
encryption application does <strong>not</strong> protect your data if your ownCloud
server is compromised, and it does not prevent ownCloud administrators from
reading users’ files. This would require client-side encryption, which this
application does not provide. If your ownCloud server is not connected to
any external storage services, it is better to use other encryption
tools, such as file-level or whole-disk encryption.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">SSL terminates at or before Apache on the ownCloud server. Consequently, all
files are in an unencrypted state between the SSL connection termination and
the ownCloud code that encrypts and decrypts them. This is, potentially,
exploitable by anyone with administrator access to your server. For more
information, read: <a class="reference external" href="https://owncloud.org/blog/how-owncloud-uses-encryption-to-protect-your-data/">How ownCloud uses encryption to protect your data</a>.</p>
</div>
<div class="section" id="encryption-types">
<h2>Encryption Types<a class="headerlink" href="#encryption-types" title="Permalink to this headline">¶</a></h2>
<p>ownCloud provides two encryption types:</p>
<ul class="simple">
<li><strong>Basic encryption:</strong> every user has their own private/public key pairs, and the private key is protected by the user’s password.</li>
<li><strong>Master Key:</strong> there is only one key (or key pair) and all files are encrypted using that key pair.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">These encryption types are <strong>not compatible</strong>.</p>
</div>
</div>
<div class="section" id="before-enabling-encryption">
<h2>Before Enabling Encryption<a class="headerlink" href="#before-enabling-encryption" title="Permalink to this headline">¶</a></h2>
<p>Plan very carefully before enabling encryption, because it is not reversible via the ownCloud Web interface.
If you lose your encryption keys, your files are <strong>not</strong> recoverable.
Always have backups of your encryption keys stored in a safe location, and consider enabling all recovery options.</p>
<p>You have more options via the <code class="docutils literal notranslate"><span class="pre">occ</span></code> command (see <a class="reference internal" href="#occ-encryption-label"><span class="std std-ref">Enabling Master Key Based Encryption</span></a>)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You can’t manage encryption without access to the command line.
If your ownCloud installation is on a hosted environment and you don’t have
access to the command line, you won’t be able to run <a class="reference internal" href="../server/occ_command.html"><span class="doc">occ commands</span></a>. In this case, <strong>don’t enable encryption</strong>!</p>
</div>
</div>
<div class="section" id="how-to-enable-encryption">
<span id="enable-encryption-label"></span><h2>How To Enable Encryption<a class="headerlink" href="#how-to-enable-encryption" title="Permalink to this headline">¶</a></h2>
<p>The base encryption system is enabled and disabled on your Admin page.
First, you must enable this, and then select an encryption module to load.
Go to the <strong>Server-side encryption</strong> section of your Admin page and check <strong>Enable encryption</strong>.</p>
<div class="figure">
<img alt="../../_images/encryption3.png" src="../../_images/encryption3.png" />
</div>
<p>After clicking <strong>Enable encryption</strong>, you will see the message “<em>No encryption module loaded, please load an encryption module in the app menu</em>”.
Currently, the only available encryption module is the ownCloud Default Encryption module.
So, go to your Apps page to enable the ownCloud Default Encryption module.</p>
<div class="figure">
<img alt="../../_images/encryption1.png" src="../../_images/encryption1.png" />
</div>
<p>Then, return to your Admin page to see that the ownCloud Default Encryption module has been added to the module selector <em>and</em> automatically selected.
Now you <strong>must</strong> log out and then log back in to initialize your encryption keys.</p>
<div class="figure">
<img alt="../../_images/encryption14.png" src="../../_images/encryption14.png" />
</div>
<p>When you log back in, a checkbox for enabling encryption on your home storage, will now be available — checked by default.
Uncheck it to avoid encrypting your home storage.</p>
<div class="figure">
<img alt="../../_images/encryption15.png" src="../../_images/encryption15.png" />
</div>
<div class="section" id="enabling-encryption-from-the-command-line">
<h3>Enabling Encryption From the Command-line<a class="headerlink" href="#enabling-encryption-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>To enable encryption via the command-line, involves two commands.
These are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enables the default encryption module app</span>
<span class="n">php</span> <span class="n">occ</span> <span class="n">app</span><span class="p">:</span><span class="n">enable</span> <span class="n">encryption</span>

<span class="c1"># Enables encryption</span>
<span class="n">php</span> <span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">enable</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please note, the commands have to be run in this order.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you already have Basic encryption enabled - you <strong>must not</strong> enable Master Key Based encryption.</p>
</div>
</div>
</div>
<div class="section" id="enabling-master-key-based-encryption">
<span id="occ-encryption-label"></span><h2>Enabling Master Key Based Encryption<a class="headerlink" href="#enabling-master-key-based-encryption" title="Permalink to this headline">¶</a></h2>
<p>To enable master key based encryption:</p>
<ol class="arabic simple">
<li>Enable the default encryption module app, using the following command</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">php</span> <span class="n">occ</span> <span class="n">app</span><span class="p">:</span><span class="n">enable</span> <span class="n">encryption</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Then enable encryption, using the following command</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">php</span> <span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">enable</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Then enable the master key, using the following command</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">php</span> <span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">select</span><span class="o">-</span><span class="n">encryption</span><span class="o">-</span><span class="nb">type</span> <span class="n">masterkey</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The master key mode has to be set up in a newly created instance.</p>
</div>
<ol class="arabic simple" start="4">
<li>Encrypt all data</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">php</span> <span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">encrypt</span><span class="o">-</span><span class="nb">all</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not typically required, as the master key is often enabled at install time.
As a result, when enabling it, there should be no data to encrypt.
But, in case it’s being enabled after install, and the installation does have files which are unencrypted, encrypt-all can be used to encrypt them.</p>
</div>
</div>
<div class="section" id="sharing-encrypted-files">
<h2>Sharing Encrypted Files<a class="headerlink" href="#sharing-encrypted-files" title="Permalink to this headline">¶</a></h2>
<p>After encryption is enabled, your users must also log out and log back in to generate their personal encryption keys.
They will see a yellow warning banner that says “<em>Encryption App is enabled, but your keys are not initialized. Please log-out and log-in again.</em>”</p>
<p>Also, share owners may need to re-share files after encryption is enabled.
Users who are trying to access the share will see a message advising them to ask the share owner to re-share the file with them.</p>
<p>For individual shares, un-share and re-share the file.
For group shares, share with any individuals who can’t access the share.
This updates the encryption, and then the share owner can remove the individual shares.</p>
<div class="figure">
<img alt="../../_images/encryption9.png" src="../../_images/encryption9.png" />
</div>
</div>
<div class="section" id="encrypting-external-mountpoints">
<h2>Encrypting External Mountpoints<a class="headerlink" href="#encrypting-external-mountpoints" title="Permalink to this headline">¶</a></h2>
<p>You and your users can encrypt individual external mount points.
You must have external storage enabled on your Admin page, and enabled for your users.
Encryption settings can be configured in the mount options for an external storage mount; see <a class="reference internal" href="external_storage_configuration_gui.html#external-storage-mount-options-label"><span class="std std-ref">Mount Options</span></a> (<a class="reference internal" href="external_storage_configuration_gui.html"><span class="doc">Configuring External Storage (GUI)</span></a>)</p>
</div>
<div class="section" id="how-to-enable-users-file-recovery-keys">
<span id="enable-file-recovery-key"></span><h2>How To Enable Users File Recovery Keys<a class="headerlink" href="#how-to-enable-users-file-recovery-keys" title="Permalink to this headline">¶</a></h2>
<p>Once a user has encrypted their files, if they lose their ownCloud password, then they lose access to their encrypted files, as their files will be unrecoverable.
It is not possible, when user files are encrypted, to reset a user’s password using the standard reset process.</p>
<p>If so, you’ll see a yellow banner warning:</p>
<blockquote>
<div>Please provide an admin recovery password; otherwise, all user data will be lost.</div></blockquote>
<p>To avoid all this, create a Recovery Key.
To do so, go to the Encryption section of your Admin page and set a recovery key password.</p>
<div class="figure">
<img alt="../../_images/encryption10.png" src="../../_images/encryption10.png" />
</div>
<p>You then need to ask your users to opt-in to the Recovery Key.
For the users to do this, they need to go to the “<strong>Personal</strong>” page and enable the recovery key.
This signals that they are OK that the admin might have a way to decrypt their data for recovery reasons.
If they do <em>not</em> do this, then the Recovery Key won’t work for them.</p>
<div class="figure">
<img alt="../../_images/encryption7.png" src="../../_images/encryption7.png" />
</div>
<p>For users who have enabled password recovery, give them a new password and recover access to their encrypted files, by supplying the Recovery Key on the Users page.</p>
<div class="figure">
<img alt="../../_images/encryption8.png" src="../../_images/encryption8.png" />
</div>
<p>You may change your recovery key password.</p>
<div class="figure">
<img alt="../../_images/encryption12.png" src="../../_images/encryption12.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Sharing a recovery key with a user group is <strong>not</strong> supported.
This is only supported with <a class="reference internal" href="#create-a-master-key"><span class="std std-ref">the master key</span></a>.</p>
</div>
</div>
<div class="section" id="changing-the-recovery-key-password">
<h2>Changing The Recovery Key Password<a class="headerlink" href="#changing-the-recovery-key-password" title="Permalink to this headline">¶</a></h2>
<p>If you have misplaced your recovery key password and need to replace it, here’s what you need to do:</p>
<ol class="arabic simple">
<li>Delete the recovery key from both <code class="docutils literal notranslate"><span class="pre">data/owncloud_private_keys</span></code> and <code class="docutils literal notranslate"><span class="pre">data/public-keys</span></code></li>
<li>Edit your database table <code class="docutils literal notranslate"><span class="pre">oc_appconfig</span></code> and remove the rows with the config keys <code class="docutils literal notranslate"><span class="pre">recoveryKeyId</span></code> and <code class="docutils literal notranslate"><span class="pre">recoveryAdminEnabled</span></code> for the appid <code class="docutils literal notranslate"><span class="pre">files_encryption</span></code></li>
<li>Login as admin and activate the recovery key again with a new password. This will generate a new key pair</li>
<li>All users who used the original recovery key will need to disable it and enable it again. This deletes the old recovery share keys from their files and encrypts their files with the new recovery key</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can only change the recovery key password if you know the original. This is by design, as only admins who know the recovery key password should be able to change it. If not, admins could hijack the recovery key from each other</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Replacing the recovery key will mean that all users will lose the possibility to recover their files until they have applied the new recovery key</p>
</div>
</div>
<div class="section" id="disabling-encryption">
<h2>Disabling Encryption<a class="headerlink" href="#disabling-encryption" title="Permalink to this headline">¶</a></h2>
<p>To disable encryption, put your ownCloud server into single-user mode, and then disable your encryption module with these commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">maintenance</span><span class="p">:</span><span class="n">singleuser</span> <span class="o">--</span><span class="n">on</span>
<span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">disable</span>
</pre></div>
</div>
<p>Take it out of single-user mode when you are finished, by using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">maintenance</span><span class="p">:</span><span class="n">singleuser</span> <span class="o">--</span><span class="n">off</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">You may only disable encryption with by using the <a class="reference internal" href="#occ-encryption-commands">occ Encryption
Commands</a>. Make sure you have backups of all encryption keys, including
those for all your users.</p>
</div>
</div>
<div class="section" id="not-all-files-are-encrypted">
<h2>Not All Files Are Encrypted<a class="headerlink" href="#not-all-files-are-encrypted" title="Permalink to this headline">¶</a></h2>
<p>Only the data in the files in <code class="docutils literal notranslate"><span class="pre">data/user/files</span></code> are encrypted, not the filenames or folder structures.</p>
<p>In addition, these files are never encrypted:</p>
<ul class="simple">
<li>Existing files in the trash bin &amp; Versions. Only new and changed files after
encryption is enabled are encrypted.</li>
<li>Image thumbnails from the Gallery app</li>
<li>Previews from the Files app</li>
<li>The search index from the full-text search app</li>
<li>Third-party app data</li>
</ul>
<p>There may be other files that are not encrypted.
Only files that are exposed to third-party storage providers are guaranteed to be encrypted.</p>
</div>
<div class="section" id="ldap-and-other-external-user-back-ends">
<h2>LDAP and Other External User Back-ends<a class="headerlink" href="#ldap-and-other-external-user-back-ends" title="Permalink to this headline">¶</a></h2>
<p>If you use an external user back-end, such as an LDAP or Samba server, and you change a user’s password on that back-end, the user will be prompted to change their ownCloud login to match on their next ownCloud login.
The user will need both their old and new passwords to do this.
If you have enabled the recovery key then you can change a user’s password in the ownCloud Users panel to match their back-end password and then — of course — notify the user and give them their new password.</p>
</div>
<div class="section" id="occ-encryption-commands">
<h2>occ Encryption Commands<a class="headerlink" href="#occ-encryption-commands" title="Permalink to this headline">¶</a></h2>
<p>If you have shell access, you may use the <code class="docutils literal notranslate"><span class="pre">occ</span></code> command to perform encryption operations.
You also have additional options such as decryption and creating a single master encryption key.
See <a class="reference internal" href="../server/occ_command.html#encryption-label"><span class="std std-ref">Encryption</span></a>  for detailed instructions on using <code class="docutils literal notranslate"><span class="pre">occ</span></code>.</p>
<div class="section" id="view-current-encryption-status">
<h3>View Current Encryption Status<a class="headerlink" href="#view-current-encryption-status" title="Permalink to this headline">¶</a></h3>
<p>Get the current encryption status and the loaded encryption module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">status</span>
 <span class="o">-</span> <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
 <span class="o">-</span> <span class="n">defaultModule</span><span class="p">:</span> <span class="n">OC_DEFAULT_MODULE</span>
</pre></div>
</div>
<p>This is equivalent to checking <strong>Enable server-side encryption</strong> on your Admin page:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">enable</span>
<span class="n">Encryption</span> <span class="n">enabled</span>

<span class="n">Default</span> <span class="n">module</span><span class="p">:</span> <span class="n">OC_DEFAULT_MODULE</span>
</pre></div>
</div>
</div>
<div class="section" id="list-available-encryption-modules">
<h3>List Available Encryption Modules<a class="headerlink" href="#list-available-encryption-modules" title="Permalink to this headline">¶</a></h3>
<p>To list the available encryption modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="nb">list</span><span class="o">-</span><span class="n">modules</span>
 <span class="o">-</span> <span class="n">OC_DEFAULT_MODULE</span><span class="p">:</span> <span class="n">Default</span> <span class="n">encryption</span> <span class="n">module</span> <span class="p">[</span><span class="n">default</span><span class="o">*</span><span class="p">]</span>
</pre></div>
</div>
<p>Select a different default Encryption module (currently the only available module is <code class="docutils literal notranslate"><span class="pre">OC_DEFAULT_MODULE</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="nb">set</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">module</span> <span class="p">[</span><span class="n">Module</span> <span class="n">ID</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<p>The [module ID] is taken from the <code class="docutils literal notranslate"><span class="pre">encryption:list-modules</span></code> command.</p>
</div>
<div class="section" id="encrypt-and-decrypt-data-files-for-all-users">
<h3>Encrypt and Decrypt Data Files For All Users<a class="headerlink" href="#encrypt-and-decrypt-data-files-for-all-users" title="Permalink to this headline">¶</a></h3>
<p>For performance reasons, when you enable encryption on an ownCloud server only new and changed files are encrypted.
This command gives you the option to encrypt all files.
You must first put your ownCloud server into single-user mode to prevent any user activity until encryption is completed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">maintenance</span><span class="p">:</span><span class="n">singleuser</span> <span class="o">--</span><span class="n">on</span>
<span class="n">Single</span> <span class="n">user</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">currently</span> <span class="n">enabled</span>
</pre></div>
</div>
<p>Then run <code class="docutils literal notranslate"><span class="pre">occ</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>occ encryption:encrypt-all

You are about to start encrypting all files stored in your ownCloud.
It will depend on the encryption module you use which files get encrypted.
Depending on the number and size of your files this can take some time.
Please make sure that no users access their files during this process!

Do you really want to continue? (y/n)
</pre></div>
</div>
<p>When you type <code class="docutils literal notranslate"><span class="pre">y</span></code> it creates a key pair for each of your users, and then encrypts their files, displaying progress until all user files are encrypted.</p>
<p>Decrypt all user data files, or optionally a single user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">decrypt</span><span class="o">-</span><span class="nb">all</span> <span class="p">[</span><span class="n">username</span><span class="p">]</span>
</pre></div>
</div>
<p>View current location of keys:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">show</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">root</span>
<span class="n">Current</span> <span class="n">key</span> <span class="n">storage</span> <span class="n">root</span><span class="p">:</span>  <span class="n">default</span> <span class="n">storage</span> <span class="n">location</span> <span class="p">(</span><span class="n">data</span><span class="o">/</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="move-key-location">
<h3>Move Key Location<a class="headerlink" href="#move-key-location" title="Permalink to this headline">¶</a></h3>
<p>Move keys to a different root folder, either locally or on a different server.
The folder must already exist, be owned by root and your HTTP group, and be restricted to root and your HTTP group.
This example is for Ubuntu Linux.
Note that the new folder is relative to your <code class="docutils literal notranslate"><span class="pre">occ</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keys</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">root</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keys</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="mi">0770</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keys</span>
<span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">change</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">root</span> <span class="o">../../../</span><span class="n">etc</span><span class="o">/</span><span class="n">keys</span>
<span class="n">Start</span> <span class="n">to</span> <span class="n">move</span> <span class="n">keys</span><span class="p">:</span>
   <span class="mi">4</span> <span class="p">[</span><span class="o">============================</span><span class="p">]</span>
<span class="n">Key</span> <span class="n">storage</span> <span class="n">root</span> <span class="n">successfully</span> <span class="n">changed</span> <span class="n">to</span> <span class="o">../../../</span><span class="n">etc</span><span class="o">/</span><span class="n">keys</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-new-master-key">
<span id="create-a-master-key"></span><h3>Create a New Master Key<a class="headerlink" href="#create-a-new-master-key" title="Permalink to this headline">¶</a></h3>
<p>Use this when you have:</p>
<ul class="simple">
<li>A single-sign-on infrastructure</li>
<li>A fresh installation with no existing data</li>
<li>Systems where encryption has not already been enabled</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">enable</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">key</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">It is not possible to disable it.</p>
</div>
</div>
<div class="section" id="recreating-an-existing-master-key">
<h3>Recreating an Existing Master Key<a class="headerlink" href="#recreating-an-existing-master-key" title="Permalink to this headline">¶</a></h3>
<p>If the master key needs replacing, for example, because it has been compromised, an occ command is available.
The command is <a class="reference internal" href="../server/occ_command.html#encryption-label"><span class="std std-ref">encryption:recreate-master-key</span></a>.
It replaces existing master key with new one and encrypts the files with the new key.</p>
</div>
</div>
<div class="section" id="id1">
<h2>Disabling Encryption<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>You may disable encryption only with <code class="docutils literal notranslate"><span class="pre">occ</span></code>.
Make sure you have backups of all the encryption keys, including those for all users.
When you do, put your ownCloud server into single-user mode, and then disable your encryption module with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">maintenance</span><span class="p">:</span><span class="n">singleuser</span> <span class="o">--</span><span class="n">on</span>
<span class="n">occ</span> <span class="n">encryption</span><span class="p">:</span><span class="n">disable</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Encryption cannot be disabled without the user’s password or <a class="reference internal" href="#enable-file-recovery-key"><span class="std std-ref">file recovery key</span></a>.
If you don’t have access to at least one of these then there is no way to decrypt all files.</p>
</div>
<p>Then, take it out of single-user mode when you are finished with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">occ</span> <span class="n">maintenance</span><span class="p">:</span><span class="n">singleuser</span> <span class="o">--</span><span class="n">off</span>
</pre></div>
</div>
<p>It is possible to disable encryption with the file recovery key, <em>if</em> every user uses them.
If so, <a class="reference internal" href="../server/occ_command.html#encryption-label"><span class="std std-ref">“decrypt all”</span></a> will use it to decrypt all files.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is <strong>not</strong> planned to move this to the next user login or a background job.
If that was done, then login passwords would need to be stored in the
database, which could be a security issue.</p>
</div>
</div>
<div class="section" id="files-not-encrypted">
<h2>Files Not Encrypted<a class="headerlink" href="#files-not-encrypted" title="Permalink to this headline">¶</a></h2>
<p>Only the data in the files in <code class="docutils literal notranslate"><span class="pre">data/user/files</span></code> are encrypted, and not the filenames or folder structures. These files are never encrypted:</p>
<ul class="simple">
<li>Existing files in the trash bin &amp; Versions. Only new and changed files after
encryption is enabled are encrypted.</li>
<li>Existing files in Versions</li>
<li>Image thumbnails from the Gallery app</li>
<li>Previews from the Files app</li>
<li>The search index from the full-text search app</li>
<li>Third-party app data</li>
</ul>
<p>There may be other files that are not encrypted; only files that are exposed to third-party storage providers are guaranteed to be encrypted.</p>
</div>
<div class="section" id="id2">
<h2>LDAP and Other External User Back-ends<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>If you use an external user back-end, such as an LDAP or Samba server, and you change a user’s password on the back-end, the user will be prompted to change their ownCloud login to match on their next ownCloud login.
The user will need both their old and new passwords to do this.
If you have enabled the Recovery Key, then you can change a user’s password in the ownCloud Users panel to match their back-end password, and then, of course, notify the user and give them their new password.</p>
</div>
<div class="section" id="encryption-migration-to-owncloud-8-0">
<span id="upgrading-encryption-label"></span><h2>Encryption migration to ownCloud 8.0<a class="headerlink" href="#encryption-migration-to-owncloud-8-0" title="Permalink to this headline">¶</a></h2>
<p>When you upgrade from older versions of ownCloud to ownCloud 8.0, you must manually migrate your encryption keys with the <em>occ</em> command after the upgrade is complete, like this example for CentOS: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">apache</span> <span class="pre">php</span> <span class="pre">occ</span> <span class="pre">encryption:migrate-keys</span></code>
You must run <em>occ</em> as your HTTP user. See <a class="reference internal" href="../server/occ_command.html"><span class="doc">Using the occ Command</span></a> to learn more about <em>occ</em>.</p>
</div>
<div class="section" id="encryption-migration-to-owncloud-8-1">
<h2>Encryption migration to ownCloud 8.1<a class="headerlink" href="#encryption-migration-to-owncloud-8-1" title="Permalink to this headline">¶</a></h2>
<p>The encryption backend has changed again in ownCloud 8.1, so you must take some additional steps to migrate encryption correctly.
If you do not follow these steps you may not be able to access your files.</p>
<p>Before you start your upgrade, put your ownCloud server into <code class="docutils literal notranslate"><span class="pre">maintenance:singleuser</span></code> mode (See <a class="reference internal" href="../../maintenance/enable_maintenance.html"><span class="doc">Maintenance Mode Configuration</span></a>.)
You must do this to prevent users and sync clients from accessing files before you have completed your encryption migration.</p>
<p>After your upgrade is complete, follow the steps in <a class="reference internal" href="#enable-encryption-label"><span class="std std-ref">How To Enable Encryption</span></a> to enable the new encryption system.
Then click the <strong>Start Migration</strong> button on your Admin page to migrate your encryption keys, or use the <code class="docutils literal notranslate"><span class="pre">occ</span></code> command.
We strongly recommend using the <code class="docutils literal notranslate"><span class="pre">occ</span></code> command; the <strong>Start Migration</strong> button is for admins who do not have access to the console, for example, installations on shared hosting.
This example is for Debian/Ubuntu Linux:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo -u www-data php occ encryption:migrate
</pre></div>
</div>
<p>This example is for Red Hat/CentOS/Fedora Linux:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo -u apache php occ encryption:migrate
</pre></div>
</div>
<p>You must run <code class="docutils literal notranslate"><span class="pre">occ</span></code> as your HTTP user; see
<a class="reference internal" href="../server/occ_command.html"><span class="doc">Using the occ Command</span></a>.</p>
<p>When you are finished, take your ownCloud server out of
<code class="docutils literal notranslate"><span class="pre">maintenance:singleuser</span></code> mode.</p>
</div>
</div>


            
<ul class="prevnext-title list-unstyled list-inline">
  <li class="prev">
    <a href="external_storage/auth_mechanisms.html" title="Previous Chapter: External Storage Authentication mechanisms"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; External Stor...</span>
    </a>
  </li>
  <li class="next">
    <a href="files_locking_transactional.html" title="Next Chapter: Transactional File Locking"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Transactional... &raquo;</span>
    </a>
  </li>
</ul>
					</div>
				</div>
			</div>
  </main>
  </div>
</div>
<div class="container">
<div class="row">
    <div class="col-lg-12 footer-social-icons">
      <p class="text-center"><a target="_blank" href="https://plus.google.com/107072838776436530705/about"><img width=50 src="../../_static/img/social/googleplus.svg" title="Follow us on Google Plus!" alt="Follow us on Google Plus!"></img></a>
      <a target="_blank" style="margin: 0 7px 0 14px;" href="https://www.facebook.com/ownClouders"><img width=50 src="../../_static/img/social/facebook.svg" title="Like our facebook page!" alt="Like our facebook page!"></img></a>
      <a target="_blank" style="margin: 0 14px 0 7px;" href="https://twitter.com/ownClouders"><img width=50 src="../../_static/img/social/twitter.svg" title="Subscribe to our twitter channel!" alt="Subscribe to our twitter channel!"></img></a>
      <a target="_blank" href="https://owncloud.org/blogfeed"><img class="img-circle" width=50 src="../../_static/img/social/rss.svg" title="Subscribe to our news feed!" alt="Subscribe to our news feed!"></img></a>
      <a target="_blank" href="http://visitor.r20.constantcontact.com/d.jsp?llr=ixens9uab&amp;p=oi&amp;m=1121878184680&amp;sit=mf4qye7jb&amp;f=cc4cd13f-acdf-45d3-b132-75252542c37d"><img class="img-circle" width=50 src="../../_static/img/social/mail.svg"  title="Subscribe to our newsletter!" alt="Subscribe to our newsletter!"></img></a></p>
    </div>
    <div class="text-center">
      All documentation licensed under the <a href="https://creativecommons.org/licenses/by/3.0/us/">Creative Commons Attribution 3.0 Unported license</a>.
    </div>
</div>
</div>
<footer class="content-info" role="contentinfo">
<div class="container">
   <div class="row">
     <div class="col-sm-2 col-sm-offset-1">
        <div class="footer-nav">
          <h4>About ownCloud</h4>
          <ul id="menu-about" class="menu">
            <li class="menu-contact"><a href="https://owncloud.org/contact/">People</a></li>
            <li class="menu-history"><a href="https://owncloud.org/history/">History</a></li>
            <li class="menu-events"><a href="https://owncloud.org/events/">Events</a></li>
            <li class="menu-press"><a href="https://owncloud.org/press">Press</a></li>
            <li class="menu-privacy"><a href="https://owncloud.org/privacy/">Privacy policy</a></li>
          </ul>
        </div>
     </div>
     <div class="col-sm-2 col-sm-offset-2">
        <div class="footer-nav">
          <h4>Resources</h4>
          <ul id="menu-support-and-documentation" class="menu">
            <li class="menu-faq"><a href="https://owncloud.org/faq/">FAQ</a></li>
            <li class="menu-support"><a href="https://owncloud.org/support/">Support</a></li>
            <li class="menu-admin-manual"><a href="https://doc.owncloud.org">Documentation</a></li>
            <li class="menu-security"><a href="https://owncloud.org/security/">Security</a></li>
            <li class="menu-store"><a href="http://www.cafepress.com/owncloudshop">ownCloud Store</a></li>
          </ul>
        </div>
     </div>
     <div class="col-sm-2 col-sm-offset-2">
        <div class="footer-nav">
          <h4>Interact</h4>
          <ul id="menu-interact" class="menu">
            <li class="menu-irc-channel"><a href="https://webchat.freenode.net/?channels=owncloud">IRC Channel</a></li>
            <li class="menu-mailing-list"><a href="https://mailman.owncloud.org/mailman/listinfo/">Mailing List</a></li>
            <li class="menu-forums"><a href="https://forum.owncloud.org/">Forums</a></li>
            <li class="menu-bug-tracker"><a href="https://owncloud.org/contribute">Get involved</a></li>
            <li class="menu-promote"><a href="https://owncloud.org/promote/">Discuss ownCloud with others</a></li>

          </ul>
        </div>
     </div>
   </div>
   <div class="row">
      <div class="col-lg-12 footer-text">
        <p>
              &copy; Copyright 2013-2018, The ownCloud developers.<br/>
        </p>
      </div>
    </div>
  </div>
</footer>
  </body>
</html>